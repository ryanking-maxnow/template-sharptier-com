---
name: Next.js (Payload Host)
description: How Next.js is used as the Payload CMS runtime host — App Router, API routes, build configuration, and ISR patterns relevant to this project.
---

# Next.js (Payload Host) Skill

## Overview

In this project, Next.js 16.x serves as the **runtime framework for Payload CMS only**. It hosts:
- `/admin` — Payload Admin Panel (React UI)
- `/api` — Payload REST/GraphQL endpoints

The **public frontend is Astro**, not Next.js. Next.js does NOT render any public-facing pages.

## Architecture Role

```
PM2 → Next.js process (port 3000)
        ├── /admin → Payload Admin Panel
        ├── /api   → Payload REST API
        └── /api/graphql → GraphQL endpoint

Nginx → Astro static files (no Next.js involvement)
```

## Project Structure (payloadcms/)

```
payloadcms/
├── src/
│   ├── app/
│   │   ├── (payload)/
│   │   │   ├── admin/[[...segments]]/page.tsx   # Admin panel
│   │   │   ├── api/[...slug]/route.ts           # REST API (auto-generated)
│   │   │   └── api/graphql/route.ts             # GraphQL
│   │   └── api/
│   │       ├── health/route.ts                  # Health check
│   │       └── rebuild/route.ts                 # Rebuild webhook
│   ├── collections/     # Payload schema definitions
│   ├── globals/         # Payload global configs
│   ├── hooks/           # Payload lifecycle hooks
│   ├── migrations/      # Database migrations
│   └── payload.config.ts
├── next.config.mjs
├── tsconfig.json
└── package.json
```

## Key Configuration

### next.config.mjs

```javascript
import { withPayload } from '@payloadcms/next/withPayload'

/** @type {import('next').NextConfig} */
const nextConfig = {
  // Payload requires this
  experimental: {
    reactCompiler: false,
  },
  // Optimize for API-only usage (no public pages)
  images: {
    remotePatterns: [
      { hostname: 'localhost' },
      { hostname: 's3.example.com' },
    ],
  },
}

export default withPayload(nextConfig)
```

### payload.config.ts (key sections)

```typescript
import { buildConfig } from 'payload'
import { postgresAdapter } from '@payloadcms/db-postgres'
import { lexicalEditor } from '@payloadcms/richtext-lexical'

export default buildConfig({
  admin: {
    user: Users.slug,
    livePreview: { /* ... */ },
  },
  collections: [Users, Articles, Pages, Media, Categories],
  globals: [SiteSettings, HomePageSettings, MenuSettings],
  db: postgresAdapter({
    pool: { connectionString: process.env.DATABASE_URL },
    push: false,
  }),
  editor: lexicalEditor(),
  plugins: [seoPlugin({}), cloudStoragePlugin({})],
  typescript: { outputFile: 'src/payload-types.ts' },
})
```

## API Routes

### Health Check
```typescript
// src/app/api/health/route.ts
export async function GET() {
  return Response.json({ status: 'ok', timestamp: new Date().toISOString() })
}
```

### Rebuild Webhook
```typescript
// src/app/api/rebuild/route.ts
export async function POST(req: Request) {
  const { secret } = await req.json()
  if (secret !== process.env.REBUILD_SECRET) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 })
  }
  // Trigger Astro rebuild via CI/CD webhook
  await fetch(process.env.ASTRO_REBUILD_WEBHOOK_URL, { method: 'POST' })
  return Response.json({ status: 'rebuild triggered' })
}
```

## Build and Run

```bash
# Development
pnpm --dir payloadcms dev
# Starts on http://localhost:3000

# Production build
pnpm --dir payloadcms build

# Production start (used by PM2)
pnpm --dir payloadcms start
# Or: next start -p 3000
```

## Next.js 16 Specifics

- **Turbopack**: Default bundler in dev mode (`next dev --turbopack`).
- **React 19**: Server Components are the default.
- **`revalidateTag()` signature change**: Requires second argument — `revalidateTag('tag', 'max')`.
- **`dynamicIO`**: New opt-in for fine-grained IO caching.
- **`use cache`**: New caching directive replacing `unstable_cache`.

## Payload-Specific Next.js Notes

1. **`@payloadcms/next`** wraps the Next.js config — always use `withPayload()`.
2. **Admin panel** is a catch-all route `admin/[[...segments]]/page.tsx`.
3. **REST API** is auto-generated by Payload at `api/[...slug]/route.ts`.
4. **No public pages**: This Next.js app has NO `(frontend)` route group. All public pages are served by Astro.
5. **`push: false`**: Critical — never allow Payload to auto-push schema changes in production.

## Official Documentation
- Next.js: https://nextjs.org/docs
- App Router: https://nextjs.org/docs/app
- Route Handlers: https://nextjs.org/docs/app/building-your-application/routing/route-handlers
- Payload + Next.js: https://payloadcms.com/docs/getting-started/installation
